<!DOCTYPE html>
<html>
  <head>
    <title>LD29</title>
    <meta charset="utf-8">
    <script type="text/javascript" src="phaser.min.js"></script>
  </head>
  <body>
    <script type="text/javascript">
      var game = new Phaser.Game(800, 600, Phaser.AUTO, '', {preload: preload, create: create, update: update});
      var player, cursors, enemies, ground, healthtext;
      function preload() {
        game.load.spritesheet('404boy', '404boy.png', 836, 1376);
        game.load.image('robot1', 'robot1.png');
        game.load.image('ground', 'ground.png');
        game.load.image('wall', 'wall.png');
      }
      function create() {
        game.physics.startSystem(Phaser.Physics.ARCADE);
        cursors = game.input.keyboard.createCursorKeys();

        ground = game.add.group();
        ground.enableBody = true;
        var grnd = ground.create(-25, 0, 'wall');
        grnd.body.immovable = true;
        grnd = ground.create(0, 575, 'ground');
        grnd.body.immovable = true;
        grnd = ground.create(800, 575, 'ground');
        grnd.body.immovable = true;
        grnd = ground.create(1600, 575, 'ground');
        grnd.body.immovable = true;
        grnd = ground.create(800, 25, 'ground');
        grnd.angle = 180;
        grnd.body.immovable = true;

        player = game.add.sprite(50, 400, '404boy');
        game.physics.arcade.enable(player);
        player.body.gravity.y = 700;
        player.health = 1.0;
        player.scale.setTo(0.1, 0.1);
        player.animations.add('left', [1], 10, true);
        player.animations.add('right', [0], 10, true);

        enemies = game.add.group();
        for (var i = 0; i < 2; i++) {
          var enemy = enemies.create(i * 175 + 175, 400, 'robot1');

          game.physics.arcade.enable(enemy);
          enemy.body.gravity.y = 100;
          enemy.body.bounce.y = 0.1;
          enemy.scale.setTo(0.1, 0.1);
        }
        healthtext = game.add.text(25, 25, "HP", {fontSize:'32px', fill: '#0F0'});
        healthtext.setText("HP: "+ player.health*100+"%");
      }
      function update() {
        game.physics.arcade.collide(player, enemies, damageAndBreak, null, this);
        game.physics.arcade.collide(player, ground);
        game.physics.arcade.collide(enemies, ground);
        enemies.forEachAlive(smashForward, this);
        if (cursors.left.isDown) {
          player.body.velocity.x -= 20;
        }
        if (cursors.right.isDown) {
          player.body.velocity.x += 20;
        }
        if (player.body.velocity.x > 0) {
          player.animations.play('right');
        } else if (player.body.velocity.x < 0) {
          player.animations.play('left');
        }
        if (cursors.up.isDown && player.body.touching.down)
        {
            player.body.velocity.y -= 500;
        }
      }
      function smashForward(enemy) {
        if (enemy.body.touching.down) {
          game.physics.arcade.accelerateToObject(enemy, player, 50, 500, 0);
        } else {
          game.physics.arcade.accelerateToObject(enemy, player, 10, 500, 100);
        }
      }
      function damageAndBreak(player, enemy) {
        if (player.body.velocity.y > 100 && enemy.key == "robot1") {
          player.body.velocity.y -= 500;
        } else {
          player.damage(0.5);
          healthtext.setText("HP: "+ player.health*100+"%");
        }
        enemy.kill();
      }
    </script>
  </body>
</html>
